# 归元弈 项目代码审核报告

## 1. 概览
对 `src/js` 目录下的核心逻辑、网络通信及状态管理模块进行了全面审核。项目整体架构清晰，采用了 事件总线 (EventBus) + 状态管理 (StateManager) + 渲染器 (Renderer) 的解耦设计。

然而，在 **PVP 网络同步**、**回合流转控制** 以及 **资源管理** 方面存在一些隐患，这很可能是导致“偶尔出现奇怪bug”的根本原因。

## 2. 核心问题发现

### 2.1. 竞态条件：天干生成的双重触发 (Critical)
**现象：** 在 PVP 模式下，客户端可能会收到两次 `game:stem-generated` 事件，导致动画播放两次或逻辑状态异常。
**原因：**
1. **路径 A (网络):** `SimplifiedPVPManager` 收到主机广播的 `stem_generated` 消息，更新状态并立即触发 `game:stem-generated`。
2. **路径 B (本地兜底):** `TurnManager.startTurn()` 内部设定了一个 `setTimeout` (0ms 或 1000ms)。在超时回调中，它会检查 `StateManager.getState().currentStem`。如果此时路径 A 已经更新了状态，路径 B 也会检测到天干存在，并再次触发 `game:stem-generated`。
**代码位置：** `src/js/logic/flow/TurnManager.js` 中的 `startTurn` 方法。

### 2.2. 状态突变与生命周期管理
**现象：** `GameEngine.js` 是一个单例对象，直接修改 `this.activeSession` 等属性。虽然它提供了 `init` 方法，但缺乏 `destroy` 或 `reset` 方法来彻底清理内部状态和事件监听器。
**风险：**
- 如果玩家执行“返回主菜单”操作，`initApp` 可能会被再次调用（取决于 `main.js` 的重置逻辑）。如果 `GameEngine` 没有被正确清理，旧的事件监听器仍然存在，导致事件被多次处理（内存泄漏 + 逻辑错误）。
- `activeSession` 状态在网络断开或异常重置时可能残留，干扰下一局游戏。

### 2.3. 权威逻辑分散
**现象：**
- `SimplifiedPVPManager` 维护了 `isHost` 状态。
- `AuthorityExecutor` 也维护了 `_isHost` 状态。
虽然 `SimplifiedPVPManager` 会同步更新 `AuthorityExecutor`，但存在两个“事实来源”增加了维护难度和潜在的不一致风险。

### 2.4. 回合结束的循环依赖风险
**现象：** `TurnManager.endTurn` -> `EventBus(game:next-turn)` -> `GameEngine` -> `TurnManager.startTurn`。
**风险：** 虽然通过 `setTimeout` 打断了调用栈，但这种紧密的事件循环耦合使得插入“暂停”、“重连等待”或“调试中断”变得困难。

## 3. 调整方案与建议

### 3.1. 修复天干生成竞态 (高优先级)
**方案：** 修改 `TurnManager.js` 的 `startTurn` 逻辑，明确区分“本地生成”和“网络同步”。
- 在 PVP 客户端模式下，`TurnManager` **不应** 主动触发 `game:stem-generated`，而应完全依赖网络消息。
- 那个 `setTimeout` 中的检查逻辑应该只用于单机模式，或者在 PVP 模式下仅做超时检测（如“等待主机响应超时”），而不是主动触发逻辑。

### 3.2. 完善 GameEngine 生命周期
**方案：**
1. 在 `GameEngine.js` 中添加 `cleanup()` 方法，移除所有 `EventBus.off` 监听器，并重置 `activeSession`。
2. 在 `main.js` 的 `EventBus.on('game:return-to-menu', ...)` 回调中，显式调用 `GameEngine.cleanup()`。

### 3.3. 优化主机权威判定
**方案：** 统一使用 `AuthorityExecutor` 作为权威判定的唯一来源。`SimplifiedPVPManager` 仅负责网络传输，询问 `AuthorityExecutor.isHost()` 来决定逻辑分支。

### 3.4. 网络异常处理增强 (建议)
**方案：** 目前的 Broadcast 机制基于 UDP 风格（发后即忘），虽然 Supabase Realtime 底层是 WebSocket，但应用层没有 ACK 机制。
- 建议：对于关键操作（如 `action`），保持目前的 `request/confirm` 机制是很好的。
- 对于 `stem_generated`，如果客户端错过了广播，当前通过 `turn_sync` 包含天干信息可能是一个补充，或者在 `TurnManager` 增加一个长超时请求状态同步。

## 4. 实施计划

我将执行以下具体的代码重构：

1.  **修改 `src/js/logic/flow/TurnManager.js`**:
    - 重构 `startTurn` 方法，移除会导致重复触发的竞态逻辑。
    - 增加明确的 `isRemote` 判断。

2.  **修改 `src/js/logic/GameEngine.js`**:
    - 添加 `cleanup` 方法。
    - 确保 `activeSession` 在每回合开始时被安全重置。

3.  **修改 `src/js/network/SimplifiedPVPManager.js`**:
    - 确保收到 `stem_generated` 时只做必要的状态更新和事件触发，避免与本地逻辑冲突。

## 5. 总结
项目的核心逻辑是稳固的。修复上述的竞态条件和生命周期管理问题后，游戏的稳定性（尤其是 PVP 模式和反复重开局的情况）将得到显著提升。

---

## 6. 整改完成记录

**整改日期**: 2026-02-06
**提交哈希**: `3f8e9a4`

### 已完成的整改项

#### 6.1. 修复天干生成竞态条件 ✅
- [x] 添加 `_turnTimer` 状态管理
- [x] 实施角色职责分离：PVP 客户端即时状态检查后直接返回
- [x] 客户端完全依赖网络同步，不再设置 setTimeout 兜底
- [x] 根治双重触发问题，确保单一数据源 (SSOT)

**修改文件**: `src/js/logic/flow/TurnManager.js`

#### 6.2. 添加生命周期清理方法 ✅
- [x] GameEngine 添加 `_eventHandlers` 引用管理和 `cleanup()`
- [x] TurnManager 添加 `cleanup()` 清除定时器
- [x] AuthorityExecutor 添加 `cleanup()` 重置状态
- [x] 防止内存泄漏和逻辑残留导致的"幽灵bug"

**修改文件**:
- `src/js/logic/GameEngine.js`
- `src/js/logic/flow/TurnManager.js`
- `src/js/logic/AuthorityExecutor.js`

#### 6.3. 统一权威逻辑到 AuthorityExecutor ✅
- [x] 移除 `SimplifiedPVPManager.isHost` 属性
- [x] 所有使用处改为 `AuthorityExecutor.isHost()`
- [x] 实现关注点分离：规则裁判 vs 数据传输

**修改文件**: `src/js/network/SimplifiedPVPManager.js`

### 后续建议

虽然核心问题已修复，但以下优化可作为未来增强项：

1. **集成 cleanup 调用**: 在 `main.js` 的 `game:return-to-menu` 事件处理中调用 `GameEngine.cleanup()`
2. **网络异常处理增强**: 为 `stem_generated` 添加 ACK 机制或超时重传
3. **回合循环解耦**: 考虑引入状态机模式管理回合流转，便于插入暂停/调试逻辑
